<template>
  <div>
    <FormField
        v-for="magnet in magnets"
        :key="magnet.id"
        :label="`Current for ${magnet.name}`"
        :name="`i_${magnet.id}`"
        :component="FormInputWithUnit"
        type="number"
        :required="true"
        :unit-options="[
          {
            name: 'Ampère',
            value: 'A',
            symbol: 'A',
            default: true,
          },
          {
            name: 'Giga Ampère',
            value: 'GA',
            symbol: 'GA',
            default: false,
          }
        ]"
    />
  </div>
</template>

<script>
import FormField from "@/components/FormField";
import FormInputWithUnit from "@/components/FormInputWithUnit";
import * as siteService from '@/services/siteService'
import * as magnetService from '@/services/magnetService'

export default {
  name: 'CurrentsField',
  inject: ['form'],
  components: { FormField },
  data: () => ({
    FormInputWithUnit,
    magnets: [],
  }),
  watch: {
    async 'form.values.resource'(resource) {
      if (!resource) {
        return
      }

      if (resource.value.type === 'site') {
        const site = await siteService.find({ id: resource.value.id })
        this.magnets = site.site_magnets
            .filter((siteMagnet) => siteMagnet.commissioned_at && !siteMagnet.decommissioned_at)
            .map((siteMagnet) => siteMagnet.magnet)
      } else if (resource.value.type === 'magnet') {
        const magnet = await magnetService.find({ id: resource.value.id })
        this.magnets = [magnet]
      }
    }
  },
}
</script>
